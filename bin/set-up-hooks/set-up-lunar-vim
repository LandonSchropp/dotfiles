#!/usr/bin/env bash

set -euo pipefail

# Grab the dotfiles directory.
cd "$(dirname "$0")/../.."
DOTFILES_DIRECTORY=$(pwd)

# Install the new version of
cd "$HOME"

# FIX: Remove any remanents of the old LunarVim installation.
rm -rf .local/share/lunarvim*
rm -f .local/bin/lvim
rm -rf .config/lvim

# Install LunarVim without the default config.
# BUG FIX: For some reason, this script exits with a non-zero status, even when the installation succeeds.
INSTALL_SCRIPT="https://raw.githubusercontent.com/lunarvim/lunarvim/rolling/utils/installer/install.sh"
(yes y | LV_BRANCH=rolling bash <(curl -s "$INSTALL_SCRIPT")) || true

# Temporarily create an empty configuration file. This is the closest I can get to a vanilla
# LunarVim setup with the default LunarVim configuration.
rm -f "$HOME/.config/lvim/config.lua"
tee "$HOME/.config/lvim/config.lua" <<EOF > /dev/null
dofile("/Users/landon/.dotfiles/config/lvim/lua/user/plugins.lua")
vim.cmd("autocmd User PackerComplete quitall")
EOF

# Install the plugins.
lvim --headless -c 'PackerSync'

# Set up the symbolic links for my configuration files.
rm -f "$HOME/.config/lvim/config.lua"
cd "$DOTFILES_DIRECTORY"
rcup -v config/lvim

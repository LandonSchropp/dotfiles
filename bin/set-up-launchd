#!/usr/bin/env bash

set -euo pipefail

# The domain, required by launchctl
domain="gui/$(id -u)"

for plist in "$HOME"/Library/LaunchAgents/com.landonschropp.*.plist; do
  # Print an empty line to space things out.
  echo

  # Extract the label from the plist file
  label=$(/usr/libexec/PlistBuddy -c "Print :Label" "$plist")

  # Validate the plist file
  if ! plutil -lint "$plist" &>/dev/null; then
    echo "Error: Invalid plist file: '$plist'"
    exit 1
  fi

  # Try to bootout the service if it's already loaded
  if launchctl print "$domain/$label" &>/dev/null; then
    echo "⏪ Unloading service: $label"
    launchctl bootout "$domain" "$plist" || true
  fi

  # Load the plist into launchd
  echo "⏩ Loading service: $label"
  launchctl bootstrap "$domain" "$plist"
done

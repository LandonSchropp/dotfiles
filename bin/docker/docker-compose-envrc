#!/usr/bin/env ruby

# frozen_string_literal: true

require 'yaml'

# This script copied the environment out of the docker-compose.yml and docker-compose.override.yml
# files into a local .envrc file. This allows you to quickly :ta

# Grab the current service name.
service_name = `docker-compose-current-service-name`
exit 1 unless $?.success?
service_name.strip!

# Grab the current service configuration.
docker_compose_configuration = YAML.load(`docker-compose config`)
exit 1 unless $?.success?
environment = docker_compose_configuration["services"][service_name]["environment"]

envrc = environment.map do |key, value|
  value = "localhost" if key =~ /_HOST\z/
  "export #{ key }=#{ value.to_s.dump }"
end.join("\n")

puts envrc

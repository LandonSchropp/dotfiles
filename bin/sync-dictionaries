#!/usr/bin/env bash

# Combines the local system dictionary with the Neovim dictionary.

set -euo pipefail

# Function to send notification on error
notify_error() {
  local error_message="$1"
  osascript -e "display notification \"$error_message\" with title \"Dictionary Sync Failed\" sound name \"Basso\""
}

# Trap errors and send notification
trap 'notify_error "Check logs at ~/Library/Logs/com.landonschropp.sync-dictionaries/"' ERR

# Define the paths to the dictionaries
local_dictionary="$HOME/Library/Spelling/LocalDictionary"
nvim_dictionary="$HOME/.config/nvim/spell/en.utf-8.add"
icloud_dictionary="$HOME/Library/Mobile Documents/com~apple~CloudDocs/dictionaries/LocalDictionary"

dictionaries=(
  "$local_dictionary"
  "$nvim_dictionary"
  "$icloud_dictionary"
)

# Ensure the directories exist and create files if they don't exist
for dict in "${dictionaries[@]}"; do
  mkdir -p "$(dirname "$dict")"
  touch "$dict"
done

# Create a temporary file for the merged dictionary
temp_dictionary=$(mktemp)

# Combine all dictionaries, sort, and remove duplicates
cat "${dictionaries[@]}" | sort | uniq >"$temp_dictionary"

# Write the combined dictionary back to all files
for dict in "${dictionaries[@]}"; do
  cp "$temp_dictionary" "$dict"
done

# Clean up
rm "$temp_dictionary"

# Regenerate the Neovim spell file
if command -v nvim &>/dev/null; then
  nvim --headless -c "mkspell! $nvim_dictionary" -c "quit"
fi

echo "Dictionary synchronization completed at $(date)."
